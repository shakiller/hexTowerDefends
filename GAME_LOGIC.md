# Логика игры и события

## Общая информация

Hex Tower Defense - это стратегическая игра на шестигранной сетке, где два игрока соревнуются за уничтожение базы противника.

## Игровое поле

### Размеры
- **Ширина**: 15 гексагонов
- **Высота**: 52 гексагона (включая базы)
- **Сетка**: 0-50 (игровое поле), 51 (база игрока 1), 0 (база игрока 2)

### Территории
- **Игрок 1**: Нижняя половина карты (y >= height / 2)
  - База: последняя строка (y = height - 1) с нечётными индексами x
  - Дополнительная строка базы: предпоследняя строка (y = height - 2) с чётными индексами x
- **Игрок 2**: Верхняя половина карты (y < height / 2)
  - База: первая строка (y = 0) со всеми индексами x

### Ворота
- **Игрок 1**: Центральная ячейка на последней строке (x = centerX, y = height - 1)
- **Игрок 2**: Центральная ячейка на первой строке (x = centerX, y = 0)

## Состояния игры

### `gameState`
- **'menu'**: Меню игры (начальное состояние)
- **'playing'**: Игра активна
- **'paused'**: Игра на паузе
- **'victory'**: Игра завершена (победа одного из игроков)

### `gameMode`
- **'pvp'**: Игрок против игрока (online режим)
- **'pve'**: Игрок против бота (бот играет автоматически)
- **'campaign'**: Кампания (игрок против бота, уровни)

### `currentPlayer`
- **1**: Ход игрока 1
- **2**: Ход игрока 2 (или бота в режимах PvE/Campaign)

## Игровые объекты

### Башни (Towers)

#### Типы
- **basic**: Базовая башня
  - Стоимость: 100 золота
  - Урон: настраивается
  - Радиус: 1 сосед (BFS)
  - Скорость стрельбы: настраивается
- **strong**: Сильная башня
  - Стоимость: 200 золота
  - Урон: настраивается (больше базовой)
  - Радиус: 2 соседа (BFS)
  - Скорость стрельбы: настраивается

#### Уровни
- **Уровень 1**: Базовая версия
- **Уровень 2**: Улучшенная версия (стоимость улучшения: 200 золота)
  - Увеличенный урон
  - Увеличенная скорость стрельбы

#### Механика
- Башни автоматически атакуют вражеских солдат и рабочих в радиусе
- Используют BFS (поиск в ширину) для определения радиуса
- Могут атаковать область (area attack) или одиночную цель
- Башни блокируют движение солдат и рабочих

### Солдаты (Soldiers)

#### Типы
- **basic**: Базовый солдат
  - Стоимость: 50 золота
  - Здоровье: настраивается
  - Урон: настраивается
  - Скорость движения: настраивается
- **strong**: Сильный солдат
  - Стоимость: 100 золота
  - Здоровье: настраивается (больше базового)
  - Урон: настраивается (больше базового)
  - Скорость движения: настраивается

#### Механика
- Солдаты создаются на базе (ворота) и автоматически идут к вражеской базе
- Используют A* алгоритм для поиска пути
- Атакуют башни и базу противника
- При достижении вражеской базы наносят урон базе
- Могут быть уничтожены башнями и другими солдатами

### Рабочие (Workers)

#### Типы
- **gatherer**: Сборщик золота
  - Стоимость: 50 золота
  - Здоровье: настраивается (по умолчанию 30)
  - Вместимость: настраивается (по умолчанию 10)
  - Скорость сбора: настраивается (по умолчанию 1000 мс на единицу)
  - Скорость движения: настраивается (по умолчанию 0.1, диапазон 0.01-0.2)
- **builder**: Строитель
  - Стоимость: 50 золота
  - Здоровье: настраивается (по умолчанию 30)
  - Скорость строительства: настраивается (по умолчанию 2000 мс)
  - Скорость движения: настраивается (по умолчанию 0.1, диапазон 0.01-0.2)

#### Механика сборщиков
1. Создаётся на базе
2. Ищет ближайшее не собранное золото
3. Идёт к золоту (A* путь)
4. Собирает золото (требуется быть в той же ячейке)
5. Возвращается на базу
6. Сдаёт золото (добавляется к золоту игрока)

#### Механика строителей
1. Создаётся на базе
2. Ожидает задачи из очереди строительства
3. Идёт к месту строительства (A* путь)
4. Строит объект (требуется быть в той же ячейке)
5. Возвращается на базе
6. Ожидает следующую задачу

### Препятствия (Obstacles)

#### Типы
- **stone**: Камень
  - Стоимость: 10 золота
  - Неразрушимый
  - Блокирует движение
- **tree**: Дерево
  - Стоимость: 5 золота
  - Разрушаемый (двойной клик)
  - Блокирует движение

#### Механика
- Препятствия блокируют движение солдат и рабочих
- Рабочие могут проходить через ворота (allowGates = true)
- Солдаты не могут проходить через ворота (allowGates = false)
- Деревья можно разрушить двойным кликом (возвращает 50% стоимости)

### Золото (Gold)

#### Генерация
- Золото генерируется случайно на карте при старте игры
- Равное количество на обеих половинах карты
- НЕ генерируется:
  - На границах карты (y = 0, y = height - 1)
  - В покрашенной зоне базы игрока 1
  - В покрашенной зоне базы игрока 2

#### Механика
- Золото собирается сборщиками
- Каждая куча имеет определённое количество золота
- Золото уменьшается по мере сбора
- Когда куча опустошена, она помечается как собранная
- Золото автоматически удаляется с баз каждые 5 секунд

## События игры

### Инициализация игры

#### `startGame(mode)`
**События:**
1. Устанавливается режим игры (pvp/pve/campaign)
2. Состояние игры меняется на 'playing'
3. Текущий игрок устанавливается на 1
4. Здоровье баз: 100
5. Начальное золото: 500 для обоих игроков
6. Генерируется золото на карте
7. Сбрасываются все объекты (башни, солдаты, рабочие, препятствия)

**Параметры:**
- `mode`: 'pvp', 'pve', или 'campaign'

### Игровой цикл (Game Loop)

#### Обновление каждые ~16 мс (60 FPS)

**События в цикле:**
1. **Обновление башен** (`updateTowers`)
   - Проверка целей в радиусе
   - Стрельба по целям
   - Применение урона
   - Обновление таймеров перезарядки

2. **Обновление солдат** (`updateSoldiers`) - только если `gameState === 'playing'`
   - Движение по пути к вражеской базе
   - Атака башен и базы
   - Проверка здоровья
   - Удаление мёртвых солдат

3. **Обновление рабочих** (`updateWorkers`) - только если `gameState === 'playing'`
   - Движение сборщиков к золоту/базе
   - Сбор золота
   - Движение строителей к месту строительства
   - Строительство объектов
   - Возврат на базу

4. **Обновление бота** (`botAI.update`) - только если `gameState === 'playing'`
   - Анализ стратегии игрока 1 (каждые 5 секунд)
   - Принятие решений (каждые 1.5 секунды)

5. **Проверка золота на базе** (каждые 5 секунд)
   - Удаление золота, попавшего на базу

6. **Рендеринг** (`render`)
   - Отрисовка всех объектов на канвасе

### События игрока

#### Размещение башни
**Триггер:** Клик на ячейку при выбранном типе башни

**Условия:**
- Ячейка свободна (нет башни, препятствия)
- Ячейка не заблокирована (не на базе, не вне границ)
- Достаточно золота (100 для basic, 200 для strong)
- Ячейка на территории игрока (для PvP)

**События:**
1. Проверка условий
2. Создание башни (`towerBloc.createTower`)
3. Вычитание золота (`gameBloc.updatePlayerGold`)
4. Обновление состояния

#### Создание солдата
**Триггер:** Клик на кнопку создания солдата

**Условия:**
- Достаточно золота (50 для basic, 100 для strong)
- Ворота свободны (нет препятствия)

**События:**
1. Проверка условий
2. Создание солдата на воротах (`soldierBloc.createSoldier`)
3. Вычисление пути к вражеской базе (A*)
4. Вычитание золота
5. Обновление состояния

#### Улучшение башни
**Триггер:** Клик на башню + кнопка улучшения

**Условия:**
- Башня уровня 1
- Достаточно золота (200)
- Башня принадлежит текущему игроку

**События:**
1. Проверка условий
2. Улучшение башни (`towerBloc.upgradeTower`)
3. Вычитание золота
4. Обновление характеристик башни
5. Обновление состояния

#### Создание рабочего
**Триггер:** Клик на кнопку создания рабочего (сборщик/строитель)

**Условия:**
- Достаточно золота (50)
- Ворота свободны

**События:**
1. Проверка условий
2. Создание рабочего на воротах (`workerBloc.createWorker`)
3. Вычитание золота
4. Обновление состояния

#### Размещение препятствия
**Триггер:** Клик на ячейку при выбранном типе препятствия (для игрока) или через очередь строительства (для бота)

**Условия:**
- Ячейка свободна
- Ячейка не заблокирована
- Достаточно золота (5 для дерева, 10 для камня)
- Есть свободный строитель (для бота)

**События:**
1. Проверка условий
2. Добавление задачи в очередь (для бота) или создание препятствия (для игрока)
3. Вычитание золота
4. Обновление состояния

#### Разрушение дерева
**Триггер:** Двойной клик на дерево

**Условия:**
- Дерево принадлежит текущему игроку (на его территории)
- Дерево не разрушено

**События:**
1. Проверка условий
2. Удаление дерева (`obstacleBloc.removeObstacle`)
3. Возврат 50% стоимости (2 золота)
4. Обновление состояния

### События боя

#### Атака башни по солдату/рабочему
**Триггер:** Автоматически при обновлении башен

**Условия:**
- Цель в радиусе башни
- Башня перезаряжена
- Цель принадлежит вражескому игроку

**События:**
1. Поиск цели в радиусе
2. Вычисление урона
3. Применение урона к цели
4. Обновление здоровья цели
5. Если цель убита - удаление
6. Обновление таймера перезарядки башни

#### Атака солдата по башне
**Триггер:** Автоматически при обновлении солдат

**Условия:**
- Солдат рядом с башней (в той же ячейке или соседней)
- Башня принадлежит вражескому игроку
- Солдат перезаряжен

**События:**
1. Поиск ближайшей вражеской башни
2. Вычисление урона
3. Применение урона к башне
4. Обновление здоровья башни
5. Если башня разрушена - удаление
6. Обновление таймера перезарядки солдата

#### Атака солдата по базе
**Триггер:** Автоматически при обновлении солдат

**Условия:**
- Солдат достиг вражеской базы (в ячейке базы)
- Солдат перезаряжен

**События:**
1. Вычисление урона
2. Применение урона к базе (`gameBloc.updatePlayerHealth`)
3. Обновление здоровья базы
4. Если здоровье базы <= 0:
   - Состояние игры меняется на 'victory'
   - Устанавливается победитель
   - Игра останавливается

### События ресурсов

#### Сбор золота
**Триггер:** Автоматически при обновлении рабочих-сборщиков

**Условия:**
- Сборщик в той же ячейке, что и золото
- Золото не собрано
- Вместимость сборщика не заполнена

**События:**
1. Сбор 1 единицы золота (`goldBloc.collectGold`)
2. Увеличение золота у сборщика
3. Уменьшение количества золота в куче
4. Если куча опустошена - пометка как собранной
5. Если вместимость заполнена - возврат на базу

#### Сдача золота на базе
**Триггер:** Автоматически при обновлении рабочих-сборщиков

**Условия:**
- Сборщик на базе (центральная ячейка)
- Сборщик несёт золото

**События:**
1. Добавление золота игроку (`gameBloc.updatePlayerGold`)
2. Сброс золота у сборщика
3. Поиск нового золота

#### Строительство объекта
**Триггер:** Автоматически при обновлении рабочих-строителей

**Условия:**
- Строитель в ячейке строительства
- Время строительства прошло
- Ячейка всё ещё свободна

**События:**
1. Создание объекта (`obstacleBloc.addObstacle` или `towerBloc.createTower`)
2. Возврат строителя на базу
3. Ожидание следующей задачи из очереди

### События управления

#### Пауза игры
**Триггер:** Клик на кнопку паузы

**События:**
1. Переключение состояния игры ('playing' ↔ 'paused')
2. Остановка игрового цикла (если пауза)
3. Обновление UI

#### Переключение игрока (PvP)
**Триггер:** Клик на кнопку переключения игрока

**Условия:**
- Режим игры: 'pvp'
- Игра активна

**События:**
1. Переключение `currentPlayer` (1 ↔ 2)
2. Обновление состояния

#### Перезапуск игры
**Триггер:** Клик на кнопку перезапуска

**События:**
1. Сброс всех состояний (`gameBloc.reset`)
2. Сброс всех объектов (башни, солдаты, рабочие, препятствия, золото)
3. Возврат в меню или начало новой игры

#### Переход на следующий уровень (Campaign)
**Триггер:** Клик на кнопку перезапуска после победы

**Условия:**
- Режим игры: 'campaign'
- Победитель: игрок 1

**События:**
1. Увеличение уровня (`gameBloc.nextLevel`)
2. Увеличение начального золота (игрок 1: +100 за уровень, игрок 2: +50 за уровень)
3. Сброс объектов
4. Начало нового уровня

### События победы/поражения

#### Победа
**Триггер:** Здоровье базы противника <= 0

**События:**
1. Состояние игры меняется на 'victory'
2. Устанавливается победитель (`gameState.winner`)
3. Игра останавливается (`stopGame`)
4. Отображается экран победы
5. Флажок победителя начинает махать (анимация)
6. Флажок проигравшего падает (наклон на 90°)

#### Поражение
**Триггер:** Здоровье собственной базы <= 0

**События:**
1. Состояние игры меняется на 'victory'
2. Устанавливается победитель (противник)
3. Игра останавливается
4. Отображается экран поражения
5. Флажок победителя начинает махать
6. Флажок проигравшего падает

## Механика пути (Pathfinding)

### A* алгоритм
Используется для поиска пути солдатами и рабочими:

**Параметры:**
- `startHex`: Начальная позиция
- `targetHex`: Целевая позиция
- `obstacleBloc`: Блок препятствий
- `towerBloc`: Блок башен
- `allowGates`: Разрешить проход через ворота (true для рабочих, false для солдат)

**Ограничения:**
- Солдаты не могут проходить через ворота
- Рабочие могут проходить через ворота
- Все объекты не могут проходить через покрашенную зону базы (кроме ворот)

### BFS для радиуса башен
Используется для определения радиуса атаки башен:

**Параметры:**
- `centerHex`: Позиция башни
- `range`: Радиус (1 для basic, 2 для strong)

**Результат:** Все гексы в радиусе (по количеству соседей)

## Визуальные события

### Анимации
- **Флажки**: Махание при победе, падение при поражении
- **Атаки**: Линии атаки, вспышки на целях
- **Движение**: Плавное перемещение солдат и рабочих

### Подсветка
- **Выбранная ячейка**: Жёлтая подсветка
- **Ячейка под курсором**: Зелёная подсветка
- **Доступные ячейки для размещения**: Синяя подсветка
- **Радиус башни**: Красная подсветка (в тестовом режиме)

## Отладочные события

### Тестовый режим башен
**Триггер:** Включение тестового режима

**События:**
- Башни реагируют на позицию курсора мыши
- Отображается радиус атаки башен
- Башни стреляют по курсору

### Режим отладки соседей
**Триггер:** Включение режима отладки соседей

**События:**
- Отображаются соседи выбранной ячейки
- Отображаются координаты ячеек

### Отладочные панели
- **Информация о солдатах**: Количество, здоровье, позиции
- **Информация о рабочих**: Количество, типы, задачи
- **Информация о ячейке**: Координаты, состояние, объекты
