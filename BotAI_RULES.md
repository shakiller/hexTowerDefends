# Правила и логика работы BotAI

## Общая информация

BotAI - это искусственный интеллект, управляющий игроком 2 в режимах PvE (Player vs Environment) и Campaign. Бот играет автоматически, независимо от текущего игрока, и принимает решения каждые 1.5 секунды.

## Стратегические параметры

### Базовые настройки
- **Интервал действий**: 1.5 секунды (1500 мс)
- **Минимальный резерв золота**: 100 единиц (для критических действий)
- **Целевое количество сборщиков**: 2
- **Целевое количество строителей**: 1
- **Радиус защиты башнями**: 3 клетки вокруг базы
- **Минимальное количество башен**: 3
- **Целевое количество солдат**: 3

### Территория бота
- Бот играет за игрока 2, база которого находится в верхней части карты (y = 0)
- Территория бота: верхняя половина карты (y < height / 2)
- Бот НЕ размещает объекты:
  - На базе (y = 0)
  - На краях карты (x < 2 или x >= width - 2)
  - В нижней половине карты (территория игрока 1)

## Система приоритетов

Бот принимает решения по следующей системе приоритетов (от высшего к низшему):

### Приоритет 1: Сбор золота
**Условия:**
- Количество сборщиков < целевого (2)
- Золото >= 50
- На карте есть не собранное золото

**Действие:** Создание сборщика золота на базе (центральная ячейка, y = 0)

### Приоритет 2: Создание строителей
**Условия:**
- Количество строителей < целевого (1)
- Золото >= 50

**Действие:** Создание строителя на базе

### Приоритет 3: Строительство препятствий
**Условия:**
- Есть строители (builders.length > 0)
- Золото >= min(100, стоимость препятствия)
- Стоимость препятствий: камень - 10, дерево - 5

**Стратегия размещения:**
1. **Использование изученной стратегии**: Бот анализирует паттерны размещения препятствий игрока 1 и адаптирует их для своей территории
2. **Оптимальное размещение**: Препятствия размещаются на пути вражеских солдат, чтобы максимально удлинить путь
3. **Создание узких проходов**: Препятствия размещаются по бокам от центра, создавая проход шириной 1 клетка
4. **Безопасность**: Препятствия НЕ должны блокировать путь между воротами

**Ограничения:**
- Максимум 5 задач в очереди строительства
- Препятствия размещаются только на территории бота
- Не размещаются на центральной линии (x = centerX)

### Приоритет 3.5: КРИТИЧЕСКАЯ ЗАЩИТА БАЗЫ
**Условия:**
- Вражеские солдаты атакуют базу или находятся в пределах 3 клеток от базы
- Золото >= 100

**Действие:** СРОЧНО размещение башни рядом с базой для защиты

**Тип башни:**
- Сильная (strong) - если золото >= 200
- Базовая (basic) - если золото < 200

### Приоритет 4: Строительство башен
**Условия:**
- Золото >= 100
- Количество башен < 8

**Стратегия размещения:**
1. **Использование изученной стратегии**: Анализ паттернов размещения башен игрока 1
2. **Оптимальное размещение**: Башни размещаются так, чтобы их зона поражения перекрывала проходы в пути вражеских солдат
3. **Защита базы**: Приоритет позициям ближе к базе (в радиусе 3 клеток)
4. **Ключевые точки**: Размещение на узких местах (chokepoints) и поворотах пути

**Тип башни:**
- Сильная (strong) - если золото >= 300
- Базовая (basic) - если золото < 300

**Ограничения:**
- Башни размещаются только на территории бота
- Минимальное расстояние между башнями: 2 клетки
- Башни НЕ должны блокировать путь между воротами

### Приоритет 5: Улучшение башен
**Условия:**
- Есть башни (botTowers.length > 0)
- Золото >= 200
- Есть башни уровня 1

**Действие:** Улучшение случайной башни уровня 1 до уровня 2

### Приоритет 6: Создание солдат для атаки
**Условия:**
- Количество башен >= минимального (3)
- Золото >= 50
- Количество солдат < целевого (3)

**Тип солдата:**
- Сильный (strong) - если золото >= 200
- Базовый (basic) - если золото < 200

**Дополнительно:** Если башен достаточно, но солдат мало (< 5), создаются дополнительные базовые солдаты для массовой атаки

### Приоритет 7: Дополнительные сборщики
**Условия:**
- На карте много золота (> 5 куч)
- Количество сборщиков < 5
- Золото >= 50

**Действие:** Создание дополнительного сборщика

## Система обучения

Бот анализирует стратегию игрока 1 и адаптирует её для своей игры:

### Анализ паттернов (каждые 5 секунд)
1. **Паттерны башен**: Анализирует расположение башен игрока 1 (расстояние от центра, расстояние от базы, тип)
2. **Паттерны препятствий**: Анализирует расположение препятствий игрока 1

### Адаптация паттернов
- Паттерны игрока 1 адаптируются для территории бота (зеркально относительно середины карты)
- Сохраняется расстояние от базы и смещение от центра
- Используется тот же тип объекта (башня/препятствие)

## Проверка блокировки пути

### Метод `wouldBlockGates(x, y, isTower)`
Проверяет, не заблокирует ли объект путь между воротами:

**Правила:**
1. Объекты на центральной линии (x = centerX) между воротами - блокируют путь
2. Объекты в центральном проходе (|x - centerX| <= 1) в первых 8 рядах от любой базы - блокируют путь
3. Объекты рядом с центральной линией (|x - centerX| <= 2) в центральной зоне карты - могут блокировать альтернативные пути

**Результат:** Если объект блокирует путь, он НЕ размещается

## Поиск позиций

### `findBestObstaclePosition()`
Находит оптимальную позицию для препятствия:
1. Вычисляет текущий путь вражеских солдат
2. Ищет позиции на пути, которые максимально удлинят путь
3. Приоритет позициям ближе к базе бота
4. Предпочитает позиции по бокам от центра (создание узких проходов)

### `findBestTowerPosition(existingTowers)`
Находит оптимальную позицию для башни:
1. Вычисляет путь вражеских солдат
2. Находит проходы в пути (участки длиной 3-5 ячеек)
3. Ищет позиции, где башня может простреливать проходы
4. Приоритет позициям с большим покрытием прохода
5. Если не найдено - использует ключевые точки (узкие места, повороты)
6. Если не найдено - использует стратегию защиты базы

### `findSafeObstaclePosition()`
Находит безопасную позицию для препятствия:
- Только на территории бота
- По бокам от центра (не на центральной линии)
- Не блокирует путь между воротами

### `findSafeTowerPosition(existingTowers)`
Находит безопасную позицию для башни:
- Только на территории бота
- В радиусе защиты базы (3 клетки)
- Не слишком близко к другим башням (минимум 2 клетки)
- Не блокирует путь между воротами

### `findDefenseTowerPositionNearBase(existingTowers)`
Находит позицию для башни рядом с базой (критическая защита):
- В радиусе 3 клеток от базы
- Только на территории бота
- Не блокирует путь

## Очередь строительства

### Ограничения
- Максимум 5 задач в очереди одновременно
- Задачи выполняются строителями по порядку
- Если очередь полна, новые задачи не добавляются

### Типы задач
1. **Препятствие** (obstacle): камень или дерево
2. **Башня** (tower): базовая или сильная

## Состояние бота

Бот отслеживает своё текущее состояние:
- `currentAction`: Текущее действие бота
- `priority`: Приоритет текущего действия
- `lastAction`: Описание последнего выполненного действия

## Особенности реализации

### Оптимизация производительности
- Упрощённая проверка блокировки пути (без полного поиска пути)
- Кеширование вычислений пути
- Ограничение количества анализируемых паттернов (максимум 10 башен, 20 препятствий)

### Обработка ошибок
- Проверка наличия необходимых блоков (workerBloc, goldBloc)
- Проверка валидности позиций перед размещением
- Множественные попытки найти безопасную позицию (до 5 попыток)

### Адаптивность
- Бот адаптируется к стратегии игрока 1
- Учитывает текущее состояние игры (количество золота, вражеские солдаты)
- Реагирует на критические ситуации (атака базы)

## Ограничения

1. **Территория**: Бот размещает объекты только на своей территории
2. **Путь**: Бот не блокирует путь между воротами
3. **Очередь**: Максимум 5 задач в очереди строительства
4. **Ресурсы**: Бот учитывает доступное золото при принятии решений
5. **Интервал**: Бот принимает решения каждые 1.5 секунды (не мгновенно)
