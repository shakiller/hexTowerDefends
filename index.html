<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hex Tower Defense</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="game-container">
        <div id="menu-screen" class="screen active">
            <h1>Hex Tower Defense</h1>
            <div class="menu-buttons">
                <button id="btn-pvp" class="menu-btn">Два игрока</button>
                <button id="btn-pve" class="menu-btn">Против бота</button>
                <button id="btn-campaign" class="menu-btn">По уровням</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="game-header">
                <div id="player1-info" class="player-info">
                    <h3>Игрок 1</h3>
                    <div class="resource">Золото: <span id="p1-gold">500</span></div>
                    <div class="resource">База: <span id="p1-health">100</span> HP</div>
                </div>
                <div id="game-controls">
                    <button id="btn-pause" class="control-btn">Пауза</button>
                    <button id="btn-menu" class="control-btn">Меню</button>
                </div>
                <div id="player2-info" class="player-info">
                    <h3>Игрок 2</h3>
                    <div class="resource">Золото: <span id="p2-gold">500</span></div>
                    <div class="resource">База: <span id="p2-health">100</span> HP</div>
                </div>
            </div>

            <div id="game-board-container">
                <canvas id="game-canvas"></canvas>
            </div>

            <div id="game-panel">
                <div id="tower-panel" class="panel-section">
                    <h4>Башни</h4>
                    <div class="tower-options">
                        <button class="tower-btn" data-type="basic" data-cost="100">
                            Базовая башня (100)
                        </button>
                        <button class="tower-btn" data-type="strong" data-cost="200">
                            Сильная башня (200)
                        </button>
                    </div>
                    <div id="selected-tower-info" class="info-panel"></div>
                </div>

                <div id="soldier-panel" class="panel-section">
                    <h4>Солдаты</h4>
                    <div class="soldier-options">
                        <button class="soldier-btn" data-type="basic" data-cost="50">
                            Базовый солдат (50)
                        </button>
                        <button class="soldier-btn" data-type="strong" data-cost="100">
                            Сильный солдат (100)
                        </button>
                    </div>
                    <div id="selected-soldier-info" class="info-panel"></div>
                </div>

                <div id="obstacle-panel" class="panel-section">
                    <h4>Препятствия</h4>
                    <div class="tower-options">
                        <button class="obstacle-btn" data-type="stone" data-cost="0">
                            Камень (бесплатно)
                        </button>
                        <button class="obstacle-btn" data-type="tree" data-cost="0">
                            Дерево (бесплатно)
                        </button>
                    </div>
                </div>

                <div id="upgrade-panel" class="panel-section">
                    <h4>Улучшения</h4>
                    <button id="btn-upgrade-tower" class="upgrade-btn" disabled>Улучшить башню</button>
                    <button id="btn-upgrade-soldier" class="upgrade-btn" disabled>Улучшить солдата</button>
                    <button id="btn-cancel-selection" class="upgrade-btn" style="background: #666; margin-top: 5px; display: none;">Отменить выбор</button>
                </div>

                <div id="settings-panel" class="panel-section">
                    <h4>Настройки</h4>
                    <div style="margin-top: 10px;">
                        <label for="soldier-speed-slider" style="color: #ccc; font-size: 0.9em; display: block; margin-bottom: 5px;">
                            Скорость солдат: <span id="soldier-speed-value">0.05</span>
                        </label>
                        <input type="range" id="soldier-speed-slider" min="0.01" max="0.1" step="0.01" value="0.05" style="width: 100%;">
                    </div>
                </div>
            </div>
        </div>

        <div id="victory-screen" class="screen">
            <h1 id="victory-text"></h1>
            <button id="btn-restart" class="menu-btn">Начать заново</button>
            <button id="btn-back-menu" class="menu-btn">В меню</button>
        </div>
    </div>

    <script>
        // Проверка загрузки
        console.log('=== index.html загружен ===');
        console.log('Протокол:', window.location.protocol);
        
        if (window.location.protocol === 'file:') {
            console.error('=== ОШИБКА: Файл открыт через file:// ===');
            console.error('ES6 модули НЕ РАБОТАЮТ через file://');
            alert('Игра не работает через file://!\n\nЗапустите локальный сервер:\n1. VS Code: "Live Server" → "Go Live"\n2. Или: python server.py\n3. Откройте http://localhost:8000');
        }
        
        window.addEventListener('error', (e) => {
            console.error('=== ГЛОБАЛЬНАЯ ОШИБКА ===', e.message, e.filename, e.lineno);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('=== UNHANDLED REJECTION ===', e.reason);
        });
    </script>
    <script>
        // Обработка ошибок от расширений браузера
        window.addEventListener('error', (e) => {
            if (e.message && e.message.includes('message channel closed')) {
                console.warn('Ошибка расширения браузера (не критично):', e.message);
                // Не блокируем выполнение - продолжаем работу
                return true;
            }
        });
        
        // Обработка необработанных Promise rejections
        // Более агрессивная обработка ошибок расширений
        window.addEventListener('unhandledrejection', (e) => {
            const reason = e.reason || {};
            const message = reason.message || reason.toString() || '';
            
            // Перехватываем все ошибки связанные с message channel
            if (message.includes('message channel') || 
                message.includes('channel closed') ||
                message.includes('listener indicated')) {
                console.warn('Ошибка расширения браузера (игнорируется):', message);
                e.preventDefault(); // Предотвращаем вывод ошибки
                return true;
            }
        });
        
        // Также перехватываем синхронные ошибки
        window.addEventListener('error', (e) => {
            const message = e.message || '';
            if (message.includes('message channel') || 
                message.includes('channel closed')) {
                console.warn('Ошибка расширения браузера (игнорируется):', message);
                e.preventDefault();
                return true;
            }
        }, true);
        
        console.log('Обработка ошибок расширений настроена');
        
        // Глобальный обработчик для диагностики - ДО загрузки модуля
        console.log('Установка глобального обработчика кликов...');
        
        // Используем setTimeout чтобы убедиться, что обработчики установлены после всех ошибок
        setTimeout(() => {
            document.addEventListener('click', (e) => {
                try {
                    const id = e.target.id || e.target.closest('button')?.id;
                    if (id === 'btn-pvp' || id === 'btn-pve' || id === 'btn-campaign') {
                        console.log('=== ГЛОБАЛЬНЫЙ ОБРАБОТЧИК: клик по кнопке меню ===', id, e.target);
                    }
                } catch (err) {
                    console.error('Ошибка в обработчике клика:', err);
                }
            }, true); // capture phase
            
            console.log('Глобальный обработчик кликов установлен');
        }, 100);
    </script>
    <script type="module" src="js/main.js?v=67"></script>
</body>
</html>
